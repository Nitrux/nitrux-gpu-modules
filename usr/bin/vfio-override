#!/bin/sh

# if 'iommu=pt' is not present in the kernel commandline, abort.
grep -q 'iommu=pt' /proc/cmdline || exit

find /sys/devices/pci* -name boot_vga -exec sh -c '
  i="$1"  # store the result of find in a parameter
  GPU="${i%/*}"
  AUDIO="${GPU%.0}.1"

  if grep -q 0 "$i"; then
    echo vfio-pci > "$GPU"/driver_override
    test -d "$AUDIO" && echo "vfio-pci" > "$AUDIO"/driver_override
  else
    if ! grep -q vfio-pci "$GPU"/driver_override; then
      continue
    fi

    dev=$(echo "$i" | grep -Eo "[0-9]{4}:[0-9]{2}:[0-9]{2}\.[0-9]")

    lspci -s "$dev" |
      grep -Ei "nvidia|amd" |
      sed "s/amd/amdgpu/" > "$GPU"/driver_override
  fi
' sh {} \;

modprobe -i vfio-pci
